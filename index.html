<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Discord Guild Leaver</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src https://discord.com;">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #202225; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #5865f2; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #7289da; }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg,#2f3136,#1e1f22);
            color:#fff;
            margin:0; padding:0;
            display:flex; justify-content:center; align-items:center;
            height:100vh;
        }
        .card {
            background:#36393f;
            padding:32px;
            border-radius:20px;
            box-shadow:0 15px 35px rgba(0,0,0,.5);
            width:100%; max-width:600px;
            animation: fadeIn 0.6s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            overflow:auto; max-height:95vh;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        h2 { color:#adb8ff; text-align:center; margin:0 0 24px; font-weight:600; }
        label { display:block; margin-top:18px; font-size:14px; }

        input[type="text"], input[type="password"], textarea {
            width:100%; padding:10px; margin-top:6px;
            border-radius:8px; border:none;
            background:#202225; color:#fff;
            font-family:monospace; resize:vertical;
        }
        textarea { overflow-y:auto; }
        input[type="number"] {
            padding:6px; margin-top:6px;
            border-radius:8px; border:none;
            background:#202225; color:#fff;
            font-family:monospace; appearance:none;
            width:80px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance:none; margin:0;
        }
        input[type="file"] { display: none; }
        .row { display:flex; gap:12px; align-items:center; }
        .row > * { flex:none; }
        .row label,
        .row .checkbox-container { margin-top:0; }

        .checkbox-container {
            display:flex; align-items:center; gap:8px;
            cursor:pointer; font-size:14px; user-select:none;
            margin-top:6px;
        }
        .checkbox-container input {
            appearance:none; width:36px; height:18px;
            background:#4f545c; border-radius:18px;
            position:relative; transition:background .3s ease;
        }
        .checkbox-container:hover input { background:#5a5f68; }
        .checkbox-container input:focus {
            outline:none; box-shadow:0 0 0 3px rgba(114,137,218,0.5);
        }
        .checkbox-container input::before {
            content:''; position:absolute;
            width:14px; height:14px; border-radius:50%;
            background:#fff; top:2px; left:2px;
            transition:transform .3s cubic-bezier(.68,-.55,.27,1.55);
        }
        .checkbox-container input:checked { background:#7289da; }
        .checkbox-container input:checked::before {
            transform:translateX(18px);
        }
        .checkbox-container span { transition:color .3s; }
        .checkbox-container input:checked + span {
            color:#adb8ff;
        }

        button.primary {
            margin-top:24px; width:100%; padding:14px;
            border:none; border-radius:14px;
            background:linear-gradient(135deg,#6d75ff,#5865f2);
            color:#fff; font-weight:700; font-size:18px;
            letter-spacing:.5px; cursor:pointer; position:relative;
            box-shadow:
                0 4px 15px rgba(88,101,242,.4),
                0 0 10px rgba(255,255,255,.1),
                inset 0 0 5px rgba(255,255,255,.2);
            overflow:hidden; transition:all .3s;
        }
        button.primary:hover {
            background:linear-gradient(135deg,#7d89ff,#4e57e0);
            box-shadow:
                0 6px 22px rgba(88,101,242,.6),
                0 0 24px rgba(255,255,255,.2),
                inset 0 0 10px rgba(255,255,255,.3);
            transform:scale(1.03);
        }
        button.primary:active {
            transform:scale(0.96);
            box-shadow:inset 0 4px 6px rgba(0,0,0,.3);
        }
        button.primary.loading {
            color: #ffffffa2; pointer-events:none;
        }
        button.secondary, .file-upload-btn {
            margin-top:8px; padding:6px 12px;
            background:#5865f2; color:#fff;
            font-size:14px; border:none; border-radius:6px;
            position:relative; overflow:hidden;
            cursor:pointer; display:inline-block;
            text-align:center; user-select:none;
        }
        button.secondary::after, .file-upload-btn::after {
            content:''; position:absolute;
            top:0; left:0; width:100%; height:100%;
            background:rgba(255,255,255,0.1);
            opacity:0; transition:opacity .3s;
        }
        button.secondary:hover::after, .file-upload-btn::hover::after { 
            opacity:1; 
        }
        button.secondary:active::after, .file-upload-btn:active::after { 
            background:rgba(255,255,255,0.2); 
        }
        .file-info {
            margin-top: 4px;
            font-size: 12px;
            color: #adb8ff;
            font-style: italic;
        }

        details { margin-top:18px; }
        summary {
            list-style:none; padding-left:20px; cursor:pointer; font-weight:600;
            position:relative; margin-top:0; user-select:none;
        }
        summary::-webkit-details-marker { display:none; }
        summary::marker { content:none; }
        summary::before {
            content:'‚ñ∂'; position:absolute; left:0; top:50%;
            transform:translateY(-50%); 
            transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        details[open] > summary::before {
            transform:translateY(-50%) rotate(90deg);
        }
        .detail-content {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
            padding-top: 0;
            transition: max-height 0.3s ease-out, 
                        opacity 0.2s ease-out, 
                        transform 0.3s ease-out, 
                        padding-top 0.3s ease-out;
            will-change: max-height, opacity, transform, padding-top;
        }
        details[open] .detail-content {
            opacity: 1;
            transform: translateY(0);
            padding-top: 5px;
            transition: max-height 0.3s ease-in, 
                        opacity 0.3s ease-in, 
                        transform 0.3s ease-in, 
                        padding-top 0.3s ease-in;
        }
        .option-item {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        details[open] .option-item {
            animation: popIn 0.5s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
            animation-delay: var(--animation-delay, 0s);
        }
        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        #log {
            margin-top:20px; padding:10px; height:120px; overflow-y:auto;
            background:#202225; border-radius:10px;
            font-family:monospace; font-size:12px; white-space:pre-wrap; resize: vertical;
        }
        @media (max-width: 600px) {
            .card {
                padding: 16px;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 10px;
            }
            h2 { font-size: 18px; margin-bottom: 16px; }
            label { font-size: 13px; margin-top: 12px; }
            input[type="text"],
            input[type="password"],
            textarea,
            input[type="number"] { padding: 8px; font-size: 12px; }
            button.primary { padding: 12px; font-size: 16px; }
            button.secondary, .file-upload-btn { padding: 8px 12px; font-size: 13px; }
            .row { flex-direction: column; align-items: stretch; }
            .row label { width: 100%; }
            .button-container { flex-direction: column; gap: 8px; }
            details summary { font-size: 13px; padding-left: 18px; }
            .checkbox-container { font-size: 13px; }
            #log { height: 80px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>Discord Guild Leaver</h2>
        <form id="leaveForm" autocomplete="off" onsubmit="return false;">
            <label>„Éà„Éº„ÇØ„É≥
                <input type="password" id="token" placeholder="„Éà„Éº„ÇØ„É≥„ÇíË≤º„Çä‰ªò„Åë" autocomplete="new-password" spellcheck="false" />
            </label>
            
            <button id="startLeave" type="button" class="primary">ÈÄÄÂá∫ÈñãÂßã</button>
        </form>

        <div id="log" style="white-space: pre-wrap; margin-top: 16px; height: 120px; overflow-y: auto;
            background: #202225; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px;"></div>

        <label>ÈÄÄÂá∫„Åó„Åü„Çµ„Éº„Éê„Éº
            <textarea id="leftServers" rows="4" readonly placeholder="ÈÄÄÂá∫„Åó„Åü„Çµ„Éº„Éê„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
        </label>
        <button id="copyLeft" class="secondary">„Ç≥„Éî„Éº</button>

        <label>‰øùÊåÅ„Åó„Åü„Çµ„Éº„Éê„Éº
            <textarea id="keptServers" rows="4" readonly placeholder="ÈÄÄÂá∫„Åó„Å™„Åã„Å£„Åü„Çµ„Éº„Éê„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
        </label>
        <button id="copyKept" class="secondary">„Ç≥„Éî„Éº</button>
    </div>

    <script>
        const x_super_properties = "eyJvcyI6IldpbmRvd3MiLCJicm93c2VyIjoiQ2hyb21lIiwiZGV2aWNlIjoiIiwic3lzdGVtX2xvY2FsZSI6ImVuLVVTIiwiaGFzX2NsaWVudF9tb2RzIjpmYWxzZSwiYnJvd3Nlcl91c2VyX2FnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEzNi4wLjAuMCBTYWZhcmkvNTM3LjM2IiwiYnJvd3Nlcl92ZXJzaW9uIjoiMTM2LjAuMC4wIiwib3NfdmVyc2lvbiI6IjEwIiwicmVmZXJyZXIiOiIiLCJyZWZlcnJpbmdfZG9tYWluIjoiIiwicmVmZXJyZXJfY3VycmVudCI6IiIsInJlZmVycmluZ19kb21haW5fY3VycmVudCI6IiIsInJlbGVhc2VfY2hhbm5lbCI6InN0YWJsZSIsImNsaWVudF9idWlsZF9udW1iZXIiOjQwNDAyMywiY2xpZW50X2V2ZW50X3NvdXJjZSI6bnVsbCwiY2xpZW50X2xhdW5jaF9pZCI6IjE2NTQzODdmLTg2NmItNDE2Ni04Zjc3LTM1ZDk2NGI3NjRmMyIsImNsaWVudF9hcHBfc3RhdGUiOiJmb2N1c2VkIn0=";
        const user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36";
        const logEl = document.getElementById('log');

        function appendLog(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `\n${time} - ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                appendLog('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            } catch (e) {
                appendLog('„Ç≥„Éî„ÉºÂ§±Êïó: ' + e);
            }
        }

        const startBtn      = document.getElementById('startLeave');
        const tokenInput    = document.getElementById('token');
        const leftArea      = document.getElementById('leftServers');
        const keptArea      = document.getElementById('keptServers');
        const copyLeftBtn   = document.getElementById('copyLeft');
        const copyKeptBtn   = document.getElementById('copyKept');
        
        copyLeftBtn.addEventListener('click', () => copyToClipboard(leftArea.value));
        copyKeptBtn.addEventListener('click', () => copyToClipboard(keptArea.value));

        const PERM_ADMINISTRATOR = 0x8;
        const PERM_MANAGE_GUILD  = 0x20;

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        startBtn.addEventListener('click', async () => {
            const tokenRaw = tokenInput.value.trim();
            if (!tokenRaw) {
                appendLog('„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            tokenInput.value = '';

            startBtn.disabled = true;
            startBtn.textContent = 'ÂÆüË°å‰∏≠...';
            startBtn.classList.add('loading');
            leftArea.value = '';
            keptArea.value = '';
            logEl.textContent = '';
            appendLog('üü¢ ÈÄÄÂá∫Âá¶ÁêÜ„ÇíÈñãÂßã');
            appendLog('üîÑ „Çµ„Éº„Éê„Éº„É™„Çπ„Éà„ÇíÂèñÂæó‰∏≠...');

            let guilds = [];
            try {
                const res = await fetch('https://discord.com/api/v9/users/@me/guilds', {
                    headers: {
                        'Authorization': tokenRaw,
                        'User-Agent': user_agent,
                        'x-super-properties': x_super_properties
                    },
                    referrerPolicy: 'no-referrer',
                    credentials: 'omit'
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        throw new Error('Ë™çË®ºÂ§±Êïó (ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥)');
                    }
                    throw new Error(`„Çµ„Éº„Éê„Éº„É™„Çπ„Éà„ÅÆÂèñÂæó„Å´Â§±Êïó (Status: ${res.status})`);
                }
                
                guilds = await res.json();
                appendLog(`„Çµ„Éº„Éê„Éº„É™„Çπ„ÉàÂèñÂæóÂÆå‰∫Ü (${guilds.length}‰ª∂)`);

            } catch (e) {
                appendLog(`„Ç®„É©„Éº: ${e.message}`);
                startBtn.disabled = false;
                startBtn.textContent = 'ÈÄÄÂá∫ÈñãÂßã';
                startBtn.classList.remove('loading');
                return;
            }

            const guildsToLeave = [];
            const guildsToKeep = [];

            for (const guild of guilds) {
                const permissions = parseInt(guild.permissions);
                const isOwner = guild.owner;
                const isAdmin = (permissions & PERM_ADMINISTRATOR) === PERM_ADMINISTRATOR;
                const canManage = (permissions & PERM_MANAGE_GUILD) === PERM_MANAGE_GUILD;

                if (isOwner || isAdmin || canManage) {
                    guildsToKeep.push(guild);
                } else {
                    guildsToLeave.push(guild);
                }
            }

            appendLog(`‰øùÊåÅÂØæË±°: ${guildsToKeep.length}‰ª∂, ÈÄÄÂá∫ÂØæË±°: ${guildsToLeave.length}‰ª∂`);
            
            keptArea.value = guildsToKeep
                .map(g => `${g.name} (ID: ${g.id})`)
                .join('\n');

            if (guildsToLeave.length === 0) {
                appendLog('ÈÄÄÂá∫ÂØæË±°„ÅÆ„Çµ„Éº„Éê„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂá¶ÁêÜÂÆå‰∫Ü„ÄÇ');
                startBtn.disabled = false;
                startBtn.textContent = 'ÈÄÄÂá∫ÈñãÂßã';
                startBtn.classList.remove('loading');
                return;
            }
            
            const leftServersList = [];

            for (const guild of guildsToLeave) {
                try {
                    const res = await fetch(`https://discord.com/api/v9/users/@me/guilds/${guild.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': tokenRaw,
                            'User-Agent': user_agent,
                            'x-super-properties': x_super_properties
                        },
                        referrerPolicy: 'no-referrer',
                        credentials: 'omit'
                    });

                    if (res.ok) {
                        appendLog(`ÈÄÄÂá∫ÊàêÂäü: ${guild.name}`);
                        leftServersList.push(guild);
                    } else if (res.status === 429) {
                        const errorBody = await res.json().catch(() => ({}));
                        const retryAfter = (errorBody.retry_after || 1.0) * 1000;
                        appendLog(`„É¨„Éº„Éà„É™„Éü„ÉÉ„Éà: ${guild.name} (${retryAfter / 1000}ÁßíÂæÖÊ©ü)`);
                        await delay(retryAfter);
                        
                        const retryRes = await fetch(`https://discord.com/api/v9/users/@me/guilds/${guild.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': tokenRaw },
                            referrerPolicy: 'no-referrer',
                            credentials: 'omit'
                        });
                        
                        if (retryRes.ok) {
                            appendLog(`ÈÄÄÂá∫ÊàêÂäü („É™„Éà„É©„Ç§): ${guild.name}`);
                            leftServersList.push(guild);
                        } else {
                            appendLog(`ÈÄÄÂá∫Â§±Êïó („É™„Éà„É©„Ç§): ${guild.name} (Status: ${retryRes.status})`);
                        }
                    } else {
                        appendLog(`ÈÄÄÂá∫Â§±Êïó: ${guild.name} (Status: ${res.status})`);
                    }
                } catch (err) {
                    appendLog(`ÈÄÄÂá∫‰∏≠„Å´„Ç®„É©„Éº: ${guild.name} ‚Üí ${err.message}`);
                }
                
                await delay(500);
            }

            leftArea.value = leftServersList
                .map(g => `${g.name} (ID: ${g.id})`)
                .join('\n');

            appendLog('ÂÖ®Âá¶ÁêÜÂÆå‰∫Ü');

            startBtn.disabled = false;
            startBtn.textContent = 'ÈÄÄÂá∫ÈñãÂßã';
            startBtn.classList.remove('loading');
        });
    </script>
</body>
</html>
